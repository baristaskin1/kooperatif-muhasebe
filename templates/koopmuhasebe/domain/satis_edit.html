{% extends "koopmuhasebe/main-body-form.html" %}

{% block form-action %}{{action}}{% endblock %}
{% block form-title %}Satış{% endblock %}
{% block form-details %}

{% load myfilters %}
{{ form2.management_form }}

{{form1.errors.as_text}}
<div class="form-group">
	<label>Tarih</label>
	<div class='input-group' id='datetimepicker1'>
		{{form1.tarih|addwidgets:"class:form-control"}}
		{{form1.tarih.errors.as_text}}
		<span class="input-group-addon">
			<span class="glyphicon glyphicon-calendar"></span>
        </span>
	</div>
  
		
</div>
 
 
 
<div class="form-group">
 <table class="table" id="tablo-siparis">
	<thead>
		<tr>
			<th>Ürün</th>
			<th>Birim Fiyat</th>
			<th>Miktar</th>
			<th>Tutar</th>
		</tr>

{{ form2.management_form }}
{% for f in form2.forms %}
<tr>
	<td>		
        {{f.urun|addclass:'form-control input-md'}}
		{{f.urun.errors.as_text}}
		
	</td> 
	<td>
		<input type=text id="id_satisstokhareketleri_set-{{ forloop.counter0 }}-urun-birim_fiyat" class="form-control input-md" readonly> 
		
       
	</td> 
	<td>		
		<div class="form-group input-group">			
			{{f.miktar|addclass:'form-control input-md miktar_kutusu'}}
			<span id="birim_span_{{ forloop.counter0 }}" class="input-group-addon">Adet</span>
			
		</div>
		{{f.miktar.errors.as_text}}			
	</td> 
	<td>		
        {{f.tutar|addclass:'form-control input-md tutar_kutusu'}}
		{{f.tutar.errors.as_text}}
	</td> 
            
    {% for field in f %}
		{% if field.is_hidden %}                                     
			{{ field}}
        {% endif %}
	{% endfor %}    
		
		
</tr>

</div>
{% endfor %}

<tr>
	<td>		
        
	</td> 
	<td>
	
       
	</td> 
	<td align="right">		
        <b>Total:</b>
	</td> 
	<td>		
			<input type=text id="total" class="form-control input-sm" readonly>     
	</td> 
            
    
		
		
</tr>


</table>


<table class="table" id="tablo-kdv">
	<thead>
		<tr>
			<th>Kdv Oranı</th>
			<th>KDV Tutarı</th>
			<th></th>
			<th></th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<script type="text/javascript">   
	
	$(document).ready(function(){
	
		
		//combodan urun secti
		$('select').on('change', function() {			
			idOfCombo=$(this).attr('id');
			valueOfCombo = $(this).val();
			idOfComboWithoutUrun = idOfCombo.substring(0, idOfCombo.length-4);
			idOfBirimFiyatKutusu = idOfComboWithoutUrun +'urun-birim_fiyat';
						
			satirSayisi = Number(idOfCombo.match(/\d+/));			
			birim = getBirimByID(valueOfCombo);
			if(birim == 'Kg')
			{
				birim = 'Gr';
				
			}
			
			$("#"+idOfBirimFiyatKutusu).val(getFiyatByID(valueOfCombo));
			//$("#birim_span_" + satirSayisi).text(birim);
			
			
			reCalculate();
			
			
		});
		
		//miktar deggisti
		//$('.miktar_kutusu').on('change', function() {			
		$('.miktar_kutusu').on('keyup', function() {					
			reCalculate();
		});
		//miktari yukari asagi oklarla da degistirebilir
		$('.miktar_kutusu').on('change', function() {					
			reCalculate();
		});
		$('.tutar_kutusu').on('focusout', function() {					
			reCalculate();
		});
		
		
	});

	function KDVleriHesapla(KDVler)
	{
		$('#tablo-kdv tbody').empty();//rowlarin hepsini sil
		
		newRowContent="";
		for(var key in KDVler)
		{
			newRowContent = "<tr><td>" + key +"</td><td></td><td>"+KDVler[key]+"</td><td></td></tr>";
			$("#tablo-kdv tbody").append(newRowContent);
		}
		
		//newRowContent = "<tr><td>" + "key" +"</td><td></td><td> KDVler[key] </td><td></td></tr>";
		
		
	}
	
	function reCalculate()
	{
		runningTotal = 0;
		var KDVler = {};
		

		for(i=0; i<25; i++)
		{
			
			//id_satisstokhareketleri_set-{{ forloop.counter0 }}-urun-birim_fiyat
			urun = $("#"+'id_satisstokhareketleri_set-'+ i +'-urun').val();			
			birimFiyat = $("#"+'id_satisstokhareketleri_set-'+ i +'-urun-birim_fiyat').val();			
			miktar = $("#"+'id_satisstokhareketleri_set-'+ i +'-miktar').val();
			//birim = $("#"+'birim_span_'+ i ).text();
			birim = getBirimByID(urun);
			
			tutar = 0;
			if(birim == 'Kg')
			{
				//tutar = Math.ceil(birimFiyat*miktar/1000);
				$("#"+'id_satisstokhareketleri_set-' + i + '-tutar').prop("readonly", false);
			}
			else
			{
				$("#"+'id_satisstokhareketleri_set-' + i + '-tutar').prop("readonly", true);
				tutar = birimFiyat*miktar;
			}
			
			tutar = tutar.toFixed(2);
			
			//if(!isNaN(tutar))	
				//runningTotal = runningTotal+ parseFloat(tutar);
			
			
			//if(!isNaN(urun) && urun != "" && tutar != 0)
			if(!isNaN(urun) && urun != "" && birim != 'Kg')
			{
				$("#"+'id_satisstokhareketleri_set-' + i + '-tutar').val(tutar);
				
			}
			
			if(urun == "")
			{
				$("#"+'id_satisstokhareketleri_set-' + i + '-urun-birim_fiyat').val("");
				$("#"+'id_satisstokhareketleri_set-' + i + '-miktar').val("");
				$("#"+'id_satisstokhareketleri_set-' + i + '-tutar').val("");
			}
			
			
			//hesaplanan degil Tutat kutusuna elle yazilan rakam
			kutudakiTutar = $("#"+'id_satisstokhareketleri_set-' + i + '-tutar').val();
			if(kutudakiTutar != "" && kutudakiTutar != undefined)
			{
				kdvOrani = getKDVByID(urun);			
				kdvTutari = kutudakiTutar/100*kdvOrani;
				kdvTutari = kdvTutari.toFixed(2);
				if(KDVler[kdvOrani] == undefined)
				{
					KDVler[kdvOrani] = parseFloat( kdvTutari);
				}
				else
				{
					KDVler[kdvOrani] = KDVler[kdvOrani] +  parseFloat( kdvTutari);
				}
				aaaa=7;
			}
			
		}
		
		TotalHesapla();
		KDVleriHesapla(KDVler);
		//$("#total").val(runningTotal);
	}

	function TotalHesapla()
	{
		runningTotal=0;
		for(sayac=0;sayac<25;sayac++)
		{
			tutar = $("#"+'id_satisstokhareketleri_set-' + sayac + '-tutar').val();
			if(!isNaN(tutar) && tutar != "")
				runningTotal = runningTotal + parseFloat(tutar);
		}
		$("#total").val(runningTotal);
		return;
	}

	function editEkranindaSayfaLoadOlurkenBirimFiyatlariGetir()
	{
		//comment'e gerek var mi? :)
		//birimleri de getirmek gerek
		for(sayac_edit=0; sayac_edit<15; sayac_edit++)
		{			
			urunID =  $("#"+'id_satisstokhareketleri_set-'+ sayac_edit +'-urun').val();
			
			urunBirimFiyat = getFiyatByID(urunID);
			if(!isNaN(urunBirimFiyat))	
				$("#"+'id_satisstokhareketleri_set-' + sayac_edit + '-urun-birim_fiyat').val(urunBirimFiyat);
			
			urunBirim2 = getBirimByID(urunID);
			//if(!isNaN(urunBirim2))
			
			/*if(urunBirim2 != '')
			{
				if(urunBirim2 == 'Kg')
					urunBirim2 = 'Gr';
				$('#birim_span_' + sayac_edit  ).text(urunBirim2);
			}*/
		}
	}
	
	var arr = [{{urun_fiyat|safe|escape}}];
	
	function getFiyatByID(key)
	{
		//var arr = ["p1","10.1","p2","20"];		
				
		var result;
		for(sayac=0;sayac<arr.length;sayac=sayac+4)
		{
			if(arr[sayac] == key)
			{
				result = arr[sayac+1];
			}
		}
		//alert(result);
		return result;
	}

	function getBirimByID(key)
	{
		//var arr = ["p1","10.1","p2","20"];		
				
		var result;
		for(ctr=0;ctr<arr.length;ctr=ctr+4)
		{
			if(arr[ctr] == key)
			{
				result = arr[ctr+2];
			}
		}
		//alert(result);
		return result;
	}

	function getKDVByID(key)
	{
		//var arr = ["p1","10.1","p2","20"];		
				
		var result;
		for(ctr=0;ctr<arr.length;ctr=ctr+4)
		{
			if(arr[ctr] == key)
			{
				result = arr[ctr+3];
			}
		}
		//alert(result);
		return result;
	}	
	
	editEkranindaSayfaLoadOlurkenBirimFiyatlariGetir();
	reCalculate();
	document.getElementById("id_satisstokhareketleri_set-0-urun").focus();
	
	
</script>

<script type="text/javascript">
            $(function () {
                $('#datetimepicker1').datetimepicker(
				{
					
					format : 'YYYY-MM-DD hh:mm',
					keepInvalid : true,
				}
				
				);
            });
</script>

{% endblock %}

